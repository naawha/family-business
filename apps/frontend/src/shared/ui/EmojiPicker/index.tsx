import { FC, useState } from 'react'
import { Group, Button, Text, Stack, Collapse, UnstyledButton } from '@mantine/core'
import { IconChevronDown, IconChevronUp } from '@tabler/icons-react'
import BaseDrawer from '../BaseDrawer'

export type EmojiCategoryKey = keyof typeof EMOJI_CATEGORIES

interface EmojiPickerProps {
  opened: boolean
  onClose: () => void
  onSelect: (emoji: string) => void
  selectedEmoji?: string | null
  /** ÐšÐ°ÐºÐ¸Ðµ ÑÐµÐºÑ†Ð¸Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ. Ð•ÑÐ»Ð¸ Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ð¾ â€” Ð²ÑÐµ. Ð•ÑÐ»Ð¸ Ð¾Ð´Ð½Ð° â€” Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¸ ÑÐ²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ. */
  categoryKeys?: EmojiCategoryKey[]
}

// ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸ (Ñ‚Ðµ Ð¶Ðµ, Ñ‡Ñ‚Ð¾ Ð² Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸)
const EMOJI_CATEGORIES = {
  faces: {
    title: 'Ð›Ð¸Ñ†Ð°',
    emojis: [
      'ðŸ˜Š',
      'ðŸ˜Ž',
      'ðŸ¥³',
      'ðŸ˜´',
      'ðŸ¤”',
      'ðŸ˜',
      'ðŸ˜€',
      'ðŸ˜ƒ',
      'ðŸ˜„',
      'ðŸ˜',
      'ðŸ˜†',
      'ðŸ˜…',
      'ðŸ¤£',
      'ðŸ˜‚',
      'ðŸ™‚',
      'ðŸ™ƒ',
      'ðŸ˜‰',
      'ðŸ˜Œ',
      'ðŸ¥°',
      'ðŸ˜˜',
      'ðŸ˜—',
      'ðŸ˜™',
      'ðŸ˜š',
      'ðŸ˜‹',
      'ðŸ˜›',
      'ðŸ˜',
      'ðŸ˜œ',
      'ðŸ¤ª',
      'ðŸ¤¨',
      'ðŸ§',
      'ðŸ¤“',
      'ðŸ¤©',
      'ðŸ˜',
      'ðŸ˜’',
      'ðŸ˜ž',
      'ðŸ˜”',
      'ðŸ˜Ÿ',
      'ðŸ˜•',
      'ðŸ™',
      'â˜¹ï¸',
      'ðŸ˜£',
      'ðŸ˜–',
      'ðŸ˜«',
      'ðŸ˜©',
      'ðŸ¥º',
      'ðŸ˜¢',
      'ðŸ˜­',
      'ðŸ˜¤',
      'ðŸ˜ ',
      'ðŸ˜¡',
      'ðŸ¤¬',
      'ðŸ¤¯',
      'ðŸ˜³',
      'ðŸ¥µ',
      'ðŸ¥¶',
      'ðŸ˜±',
      'ðŸ˜¨',
      'ðŸ˜°',
      'ðŸ˜¥',
      'ðŸ˜“',
      'ðŸ¤—',
      'ðŸ¤­',
      'ðŸ¤«',
      'ðŸ¤¥',
      'ðŸ˜¶',
      'ðŸ˜',
      'ðŸ˜‘',
      'ðŸ˜¬',
      'ðŸ™„',
      'ðŸ˜¯',
      'ðŸ˜¦',
      'ðŸ˜§',
      'ðŸ˜®',
      'ðŸ˜²',
      'ðŸ¥±',
      'ðŸ¤¤',
      'ðŸ˜ª',
      'ðŸ˜µ',
      'ðŸ¤',
      'ðŸ¥´',
      'ðŸ¤¢',
      'ðŸ¤®',
      'ðŸ¤§',
      'ðŸ˜·',
      'ðŸ¤’',
      'ðŸ¤•',
    ],
  },
  animals: {
    title: 'Ð–Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ðµ',
    emojis: [
      'ðŸ¶',
      'ðŸ±',
      'ðŸ­',
      'ðŸ¹',
      'ðŸ°',
      'ðŸ¦Š',
      'ðŸ»',
      'ðŸ¼',
      'ðŸ¨',
      'ðŸ¯',
      'ðŸ¦',
      'ðŸ®',
      'ðŸ·',
      'ðŸ¸',
      'ðŸµ',
      'ðŸ™ˆ',
      'ðŸ™‰',
      'ðŸ™Š',
      'ðŸ’',
      'ðŸ”',
      'ðŸ§',
      'ðŸ¦',
      'ðŸ¤',
      'ðŸ£',
      'ðŸ¥',
      'ðŸ¦†',
      'ðŸ¦…',
      'ðŸ¦‰',
      'ðŸ¦‡',
      'ðŸº',
      'ðŸ—',
      'ðŸ´',
      'ðŸ¦„',
      'ðŸ',
      'ðŸ›',
      'ðŸ¦‹',
      'ðŸŒ',
      'ðŸž',
      'ðŸœ',
      'ðŸ¦Ÿ',
      'ðŸ¦—',
      'ðŸ•·ï¸',
      'ðŸ¦‚',
      'ðŸ¢',
      'ðŸ',
      'ðŸ¦Ž',
      'ðŸ¦–',
      'ðŸ¦•',
      'ðŸ™',
      'ðŸ¦‘',
      'ðŸ¦',
      'ðŸ¦ž',
      'ðŸ¦€',
      'ðŸ¡',
      'ðŸ ',
      'ðŸŸ',
      'ðŸ¬',
      'ðŸ³',
      'ðŸ‹',
      'ðŸ¦ˆ',
      'ðŸŠ',
      'ðŸ…',
      'ðŸ†',
      'ðŸ¦“',
      'ðŸ¦',
      'ðŸ¦§',
      'ðŸ˜',
      'ðŸ¦›',
      'ðŸ¦',
      'ðŸª',
      'ðŸ«',
      'ðŸ¦’',
      'ðŸ¦˜',
      'ðŸ¦¡',
    ],
  },
  food: {
    title: 'Ð•Ð´Ð°',
    emojis: [
      'ðŸ',
      'ðŸŽ',
      'ðŸ',
      'ðŸŠ',
      'ðŸ‹',
      'ðŸŒ',
      'ðŸ‰',
      'ðŸ‡',
      'ðŸ“',
      'ðŸˆ',
      'ðŸ’',
      'ðŸ‘',
      'ðŸ¥­',
      'ðŸ',
      'ðŸ¥¥',
      'ðŸ¥',
      'ðŸ…',
      'ðŸ†',
      'ðŸ¥‘',
      'ðŸ¥¦',
      'ðŸ¥¬',
      'ðŸ¥’',
      'ðŸŒ¶ï¸',
      'ðŸŒ½',
      'ðŸ¥•',
      'ðŸ¥”',
      'ðŸ ',
      'ðŸ¥',
      'ðŸ¥¯',
      'ðŸž',
      'ðŸ¥–',
      'ðŸ¥¨',
      'ðŸ§€',
      'ðŸ¥š',
      'ðŸ³',
      'ðŸ¥ž',
      'ðŸ¥“',
      'ðŸ¥©',
      'ðŸ—',
      'ðŸ–',
      'ðŸ¦´',
      'ðŸŒ­',
      'ðŸ”',
      'ðŸŸ',
      'ðŸ•',
      'ðŸ¥ª',
      'ðŸ¥™',
      'ðŸŒ®',
      'ðŸŒ¯',
      'ðŸ¥—',
      'ðŸ¥˜',
      'ðŸ¥«',
      'ðŸ',
      'ðŸœ',
      'ðŸ²',
      'ðŸ›',
      'ðŸ£',
      'ðŸ±',
      'ðŸ¥Ÿ',
      'ðŸ¥ ',
      'ðŸ¥¡',
      'ðŸ¤',
      'ðŸ™',
      'ðŸš',
      'ðŸ˜',
      'ðŸ¥',
      'ðŸ¥®',
      'ðŸ¢',
      'ðŸ¡',
      'ðŸ§',
      'ðŸ¨',
      'ðŸ¦',
      'ðŸ¥§',
      'ðŸ°',
      'ðŸŽ‚',
      'ðŸ®',
      'ðŸ­',
      'ðŸ¬',
      'ðŸ«',
      'ðŸ¿',
      'ðŸ©',
      'ðŸª',
      'ðŸŒ°',
      'ðŸ¥œ',
      'ðŸ¯',
      'ðŸ¥›',
      'ðŸ¼',
      'â˜•ï¸',
      'ðŸµ',
      'ðŸ¥¤',
      'ðŸ¶',
      'ðŸº',
      'ðŸ»',
      'ðŸ¥‚',
      'ðŸ·',
      'ðŸ¥ƒ',
      'ðŸ¸',
      'ðŸ¹',
      'ðŸ§ƒ',
      'ðŸ§‰',
      'ðŸ§Š',
    ],
  },
  activities: {
    title: 'ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸',
    emojis: [
      'âš½',
      'ðŸ€',
      'ðŸˆ',
      'âš¾',
      'ðŸ¥Ž',
      'ðŸŽ¾',
      'ðŸ',
      'ðŸ‰',
      'ðŸ¥',
      'ðŸŽ±',
      'ðŸ“',
      'ðŸ¸',
      'ðŸ’',
      'ðŸ‘',
      'ðŸ¥',
      'ðŸ',
      'ðŸ¥…',
      'â›³',
      'ðŸ¹',
      'ðŸŽ£',
      'ðŸ¥Š',
      'ðŸ¥‹',
      'ðŸŽ½',
      'ðŸ›¹',
      'ðŸ›·',
      'â›¸ï¸',
      'ðŸ¥Œ',
      'ðŸŽ¿',
      'â›·ï¸',
      'ðŸ‚',
      'ðŸ‹ï¸â€â™€ï¸',
      'ðŸ‹ï¸',
      'ðŸ¤¼â€â™€ï¸',
      'ðŸ¤¼â€â™‚ï¸',
      'ðŸ¤¸â€â™€ï¸',
      'ðŸ¤¸â€â™‚ï¸',
      'â›¹ï¸â€â™€ï¸',
      'â›¹ï¸',
      'ðŸ¤º',
      'ðŸ¤¾â€â™€ï¸',
      'ðŸ¤¾â€â™‚ï¸',
      'ðŸŒï¸â€â™€ï¸',
      'ðŸŒï¸',
      'ðŸ‡',
      'ðŸ§˜â€â™€ï¸',
      'ðŸ§˜â€â™‚ï¸',
      'ðŸ„â€â™€ï¸',
      'ðŸ„',
      'ðŸŠâ€â™€ï¸',
      'ðŸŠ',
      'ðŸ¤½â€â™€ï¸',
      'ðŸ¤½â€â™‚ï¸',
      'ðŸš£â€â™€ï¸',
      'ðŸš£',
      'ðŸ§—â€â™€ï¸',
      'ðŸ§—â€â™‚ï¸',
      'ðŸšµâ€â™€ï¸',
      'ðŸšµ',
      'ðŸš´â€â™€ï¸',
      'ðŸš´',
      'ðŸ†',
      'ðŸ¥‡',
      'ðŸ…',
      'ðŸŽ–',
      'ðŸµ',
      'ðŸŽª',
      'ðŸ¤¹â€â™€ï¸',
      'ðŸ¤¹â€â™‚ï¸',
      'ðŸŽ­',
      'ðŸŽ¨',
      'ðŸŽ¬',
      'ðŸŽ¤',
      'ðŸŽ§',
      'ðŸŽ¼',
      'ðŸŽ¹',
      'ðŸ¥',
      'ðŸŽ·',
      'ðŸŽº',
      'ðŸŽ¸',
      'ðŸª•',
      'ðŸŽ»',
      'ðŸŽ²',
      'â™Ÿï¸',
      'ðŸŽ¯',
      'ðŸŽ³',
      'ðŸŽ®',
      'ðŸŽ°',
      'ðŸ§©',
    ],
  },
  objects: {
    title: 'ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹',
    emojis: [
      'âŒš',
      'ðŸ“±',
      'ðŸ“²',
      'ðŸ’»',
      'âŒ¨ï¸',
      'ðŸ–¥',
      'ðŸ–¨',
      'ðŸ–±',
      'ðŸ–²',
      'ðŸ•¹',
      'ðŸ—œ',
      'ðŸ’¾',
      'ðŸ’¿',
      'ðŸ“€',
      'ðŸ“¼',
      'ðŸ“·',
      'ðŸ“¸',
      'ðŸ“¹',
      'ðŸŽ¥',
      'ðŸ“½',
      'ðŸŽž',
      'ðŸ“ž',
      'â˜Žï¸',
      'ðŸ“Ÿ',
      'ðŸ“ ',
      'ðŸ“º',
      'ðŸ“»',
      'ðŸŽ™',
      'ðŸŽš',
      'ðŸŽ›',
      'â±',
      'â²',
      'â°',
      'ðŸ•°',
      'âŒ›',
      'â³',
      'ðŸ“¡',
      'ðŸ”‹',
      'ðŸ”Œ',
      'ðŸ’¡',
      'ðŸ”¦',
      'ðŸ•¯',
      'ðŸ§¯',
      'ðŸ›¢',
      'ðŸ’¸',
      'ðŸ’µ',
      'ðŸ’´',
      'ðŸ’¶',
      'ðŸ’·',
      'ðŸ’°',
      'ðŸ’³',
      'ðŸ’Ž',
      'âš–ï¸',
      'ðŸ› ',
      'ðŸ”¨',
      'âš’',
      'â›',
      'ðŸ”©',
      'âš™ï¸',
      'â›“',
      'ðŸ”«',
      'ðŸ’£',
      'ðŸ§¨',
      'ðŸ”ª',
      'ðŸ—¡',
      'âš”ï¸',
      'ðŸ›¡',
      'ðŸš¬',
      'âš°ï¸',
      'âš±ï¸',
      'ðŸº',
      'ðŸ”®',
      'ðŸ“¿',
      'ðŸ§¿',
      'ðŸ’ˆ',
      'âš—ï¸',
      'ðŸ”­',
      'ðŸ”¬',
      'ðŸ•³',
      'ðŸ’Š',
      'ðŸ’‰',
      'ðŸ§¬',
      'ðŸ¦ ',
      'ðŸ§«',
      'ðŸ§ª',
      'ðŸŒ¡',
      'ðŸ§¹',
      'ðŸ§º',
      'ðŸ§»',
      'ðŸš½',
      'ðŸš°',
      'ðŸš¿',
      'ðŸ›',
      'ðŸ›€',
      'ðŸ§¼',
      'ðŸ§½',
      'ðŸ§´',
      'ðŸ›Ž',
      'ðŸ”‘',
      'ðŸ—',
      'ðŸšª',
      'ðŸª‘',
      'ðŸ›‹',
      'ðŸ›',
      'ðŸ›Œ',
      'ðŸ§¸',
      'ðŸ–¼',
      'ðŸ›',
      'ðŸ›’',
      'ðŸŽ',
      'ðŸŽˆ',
      'ðŸŽ‰',
      'ðŸŽŠ',
      'ðŸŽ€',
      'ðŸŽ',
      'ðŸ®',
      'ðŸŽŽ',
      'ðŸ§§',
      'âœ‰ï¸',
      'ðŸ“©',
      'ðŸ“¨',
      'ðŸ“§',
      'ðŸ’Œ',
      'ðŸ“¥',
      'ðŸ“¤',
      'ðŸ“¦',
      'ðŸ·',
      'ðŸ“ª',
      'ðŸ“«',
      'ðŸ“¬',
      'ðŸ“­',
      'ðŸ“®',
      'ðŸ“¯',
      'ðŸ“œ',
      'ðŸ“ƒ',
      'ðŸ“„',
      'ðŸ“‘',
      'ðŸ“Š',
      'ðŸ“ˆ',
      'ðŸ“‰',
      'ðŸ—’',
      'ðŸ—“',
      'ðŸ“†',
      'ðŸ“…',
      'ðŸ—‘',
      'ðŸ“‡',
      'ðŸ—ƒ',
      'ðŸ—³',
      'ðŸ—„',
      'ðŸ“‹',
      'ðŸ“',
      'ðŸ“‚',
      'ðŸ—‚',
      'ðŸ—ž',
      'ðŸ“°',
      'ðŸ““',
      'ðŸ“”',
      'ðŸ“’',
      'ðŸ“•',
      'ðŸ“—',
      'ðŸ“˜',
      'ðŸ“™',
      'ðŸ“š',
      'ðŸ“–',
      'ðŸ”–',
      'ðŸ§·',
      'ðŸ”—',
      'ðŸ“Ž',
      'ðŸ–‡',
      'ðŸ“',
      'ðŸ“',
      'ðŸ§®',
      'ðŸ“Œ',
      'ðŸ“',
      'âœ‚ï¸',
      'ðŸ–Š',
      'ðŸ–‹',
      'âœ’ï¸',
      'ðŸ–Œ',
      'ðŸ–',
      'ðŸ“',
      'âœï¸',
      'ðŸ”',
      'ðŸ”Ž',
      'ðŸ”',
      'ðŸ”',
      'ðŸ”’',
      'ðŸ”“',
    ],
  },
}

const ALL_CATEGORY_KEYS = Object.keys(EMOJI_CATEGORIES) as EmojiCategoryKey[]

const renderEmojiGrid = (
  emojis: string[],
  selectedEmoji: string | null | undefined,
  onSelect: (emoji: string) => void,
  onClose: () => void,
) => (
  <Group gap="xs" wrap="wrap">
    {emojis.map((emoji) => (
      <Button
        key={emoji}
        variant={selectedEmoji === emoji ? 'filled' : 'subtle'}
        size="lg"
        p={0}
        style={{
          width: 56,
          height: 56,
          fontSize: 28,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
        }}
        onClick={() => {
          onSelect(emoji)
          onClose()
        }}
      >
        {emoji}
      </Button>
    ))}
  </Group>
)

const EmojiPicker: FC<EmojiPickerProps> = ({
  opened,
  onClose,
  onSelect,
  selectedEmoji,
  categoryKeys,
}) => {
  const visibleKeys = categoryKeys?.length
    ? (categoryKeys.filter((k) => k in EMOJI_CATEGORIES) as EmojiCategoryKey[])
    : ALL_CATEGORY_KEYS

  const [expandedKeys, setExpandedKeys] = useState<Set<string>>(() => new Set(visibleKeys))

  const toggleSection = (key: string) => {
    setExpandedKeys((prev) => {
      const next = new Set(prev)
      if (next.has(key)) next.delete(key)
      else next.add(key)
      return next
    })
  }

  const singleSection = visibleKeys.length === 1
  const entries = visibleKeys.map((key) => [key, EMOJI_CATEGORIES[key]] as const)

  return (
    <BaseDrawer opened={opened} onClose={onClose} title="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸">
      <Stack gap="md" py="sm">
        {singleSection ? (
          renderEmojiGrid(
            entries[0][1].emojis,
            selectedEmoji,
            onSelect,
            onClose,
          )
        ) : (
          entries.map(([key, category]) => {
            const isExpanded = expandedKeys.has(key)
            return (
              <div key={key}>
                <UnstyledButton
                  onClick={() => toggleSection(key)}
                  style={{ display: 'block', width: '100%' }}
                >
                  <Group gap="xs" wrap="nowrap">
                    <Text fw={600} size="sm" c="dimmed">
                      {category.title}
                    </Text>
                    {isExpanded ? (
                      <IconChevronUp size={16} />
                    ) : (
                      <IconChevronDown size={16} />
                    )}
                  </Group>
                </UnstyledButton>
                <Collapse in={isExpanded}>
                  <Stack gap="xs" mt="xs">
                    {renderEmojiGrid(
                      category.emojis,
                      selectedEmoji,
                      onSelect,
                      onClose,
                    )}
                  </Stack>
                </Collapse>
              </div>
            )
          })
        )}
      </Stack>
    </BaseDrawer>
  )
}

export default EmojiPicker
