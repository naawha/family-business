// Prisma schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  name        String
  avatarEmoji String?
  avatarColor String?  // HEX color
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  familyMembers     FamilyMember[]
  createdTodos      Todo[]              @relation("TodoCreator")
  assignedTodos     Todo[]              @relation("TodoAssignee")
  createdShopping   ShoppingItem[]
  createdPlanned    PlannedPurchase[]
  createdRecipes    Recipe[]
}

model Family {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members           FamilyMember[]
  invites           Invite[]
  todos             Todo[]
  shoppingItems     ShoppingItem[]
  plannedPurchases  PlannedPurchase[]
  recurringRules    RecurringRule[]
  recipes           Recipe[]
}

model FamilyMember {
  id       String   @id @default(uuid())
  familyId String
  userId   String
  role     String // 'admin' | 'member'
  joinedAt DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
}

model Invite {
  id        String   @id @default(uuid())
  familyId  String
  token     String   @unique
  email     String?  // null for QR-only
  role      String   @default("member") // 'admin' | 'member'
  kind      String   // 'email' | 'qr'
  status    String   @default("pending") // 'pending' | 'accepted' | 'expired'
  expiresAt DateTime
  inviterId String?
  createdAt DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
}

model Todo {
  id              String    @id @default(uuid())
  familyId        String
  title           String
  description     String?
  completed       Boolean   @default(false)
  isImportant     Boolean   @default(false)
  dueDate         DateTime?
  createdById     String
  assignedToId    String?
  recurringRuleId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  family       Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy    User            @relation("TodoCreator", fields: [createdById], references: [id])
  assignedTo   User?           @relation("TodoAssignee", fields: [assignedToId], references: [id])
  recurringRule RecurringRule? @relation(fields: [recurringRuleId], references: [id])
}

model ShoppingItem {
  id                String   @id @default(uuid())
  familyId          String
  name              String
  quantity          Int?
  unit              String?  // '—à—Ç' | '–≥' | '–∫–≥' | '–ª' | '–º–ª'
  category          String?
  purchased         Boolean  @default(false)
  createdById       String
  recipeId          String?  // –°–≤—è–∑—å —Å —Ä–µ—Ü–µ–ø—Ç–æ–º, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑ —Ä–µ—Ü–µ–ø—Ç–∞
  recipeIngredientId String? // –°–≤—è–∑—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–º —Ä–µ—Ü–µ–ø—Ç–∞
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  family    Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])
  recipe    Recipe? @relation(fields: [recipeId], references: [id], onDelete: SetNull)
}

model PlannedPurchase {
  id            String    @id @default(uuid())
  familyId      String
  name          String
  description   String?
  estimatedCost Float?
  targetDate    DateTime?
  priority      String    @default("medium")
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  family    Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])
}

model RecurringRule {
  id             String   @id @default(uuid())
  familyId       String
  frequency      String   // 'daily' | 'weekly' | 'monthly' | 'yearly'
  interval       Int
  startDate      DateTime
  endDate        DateTime?
  nextOccurrence DateTime
  templateData   String   // JSON string
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  todos  Todo[]
}

model Recipe {
  id          String   @id @default(uuid())
  familyId   String?  // null –¥–ª—è –æ–±—â–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤, String –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö
  name        String
  imageUrl    String?
  category    String?  // 'breakfast' | 'lunch' | 'dinner' | 'dessert' | 'snack' | 'other'
  servings    Int      @default(4) // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  emoji       String?  // –≠–º–æ–¥–∑–∏ —Ä–µ—Ü–µ–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä üç≥)
  instructions String? // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é (—Ç–µ–∫—Å—Ç –∏–ª–∏ JSON)
  isPublic    Boolean  @default(false) // –û–±—â–∏–π —Ä–µ—Ü–µ–ø—Ç –∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–º—å–∏
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  family         Family?          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy      User             @relation(fields: [createdById], references: [id])
  ingredients    RecipeIngredient[]
  shoppingItems  ShoppingItem[]
}

model RecipeIngredient {
  id          String   @id @default(uuid())
  recipeId    String
  name        String   // –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
  quantity    Float    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –æ–¥–Ω—É –ø–æ—Ä—Ü–∏—é
  unit        String?  // '—à—Ç' | '–≥' | '–∫–≥' | '–ª' | '–º–ª' | '—Å—Ç.–ª.' | '—á.–ª.' | '—Å—Ç–∞–∫–∞–Ω'
  notes       String?  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–æ –≤–∫—É—Å—É")
  order       Int      @default(0) // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}
